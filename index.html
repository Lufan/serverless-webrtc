<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>WebRTC chat</title>
  </head>
  <body>
    <p>
      Open the JS console! To create a room, use <code>create()</code>.
    </p>
    <script>
      var sdpConstraints = {
        optional: [],
        mandatory: {
          OfferToReceiveAudio: true,
          OfferToReceiveVideo: true
        }
      };

      function newPeerConn() {
        var RTCPeerConnection = window.RTCPeerConnection || webkitRTCPeerConnection || mozRTCPeerConnection;
        var conn = new RTCPeerConnection(
          {'iceServers': [{'urls': ['stun:23.21.150.121']}]},
          {'optional': [{'DtlsSrtpKeyAgreement': true}]}
        );
        conn.onconnection = function () {
          console.log('Datachannel connected');
        };
        return conn;
      }

      var dataChannel;

      function create() {
        var pc1 = newPeerConn();
        dataChannel = pc1.createDataChannel('test', {reliable: true});

        window.say = function(msg) {
          dataChannel.send(msg);
        };

        dataChannel.onopen = function (e) {
          console.log('Say things with say("hello")');
        };
        dataChannel.onmessage = function (e) {
          console.log('Got message (pc1)', e.data);
        };
        pc1.createOffer(
          function (desc) {
            pc1.setLocalDescription(desc, function () {}, function () {});
          },
          function () { console.warn("Couldn't create offer") },
          sdpConstraints
        );
        pc1.onicecandidate = function(e) {
          if (e.candidate == null) {
            console.log("Get joiners to call: ", "join(", JSON.stringify(pc1.localDescription), ")");
          }
        };
        window.gotAnswer = function(answer) {
          var answerDesc = new RTCSessionDescription(answer);
          pc1.setRemoteDescription(answerDesc);
        };
      }

      function join(offer) {
        var pc2 = newPeerConn();

        pc2.ondatachannel = function(e) {
          dataChannel = e.channel || e; // Chrome sends event, FF sends raw channel

          window.say = function(msg) {
            dataChannel.send(msg);
          };
          dataChannel.onopen = function (e) {
            console.log('data channel connect');
          }
          dataChannel.onmessage = function (e) {
            console.log('Got message (pc2)', e.data);
          }
        };

        pc2.onicecandidate = function (e) {
          if (e.candidate == null) {
            console.log("Get the creator to call: gotAnswer(", JSON.stringify(pc2.localDescription), ")");
          }
        };

        var offerDesc = new RTCSessionDescription(offer);
        pc2.setRemoteDescription(offerDesc);
        pc2.createAnswer(
          function (answerDesc) {
            pc2.setLocalDescription(answerDesc);
          },
          function () { console.warn("Couldn't create offer") },
          sdpConstraints
        );
      }
    </script>
  </body>
</html>
